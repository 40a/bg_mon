<html>
<head>
<script>
function loadJSON(path, success, error)
{
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function()
    {
        if (xhr.readyState === XMLHttpRequest.DONE) {
            if (xhr.status === 200) {
                if (success)
                    success(JSON.parse(xhr.responseText));
            } else {
                if (error)
                    error(xhr);
            }
        }
    };
    xhr.open('GET', path, true);
    xhr.send();
}

function disk_stats(data) {
	var tmpl = document.getElementById('disk_stats_tmpl');
	tmpl.style.display = '';
	var rows = [];
	for (key in data) {
		data[key]['device']['type'] = key;
		apply(data[key], 'disk_stats.');
		rows.push(tmpl.outerHTML);
	}
	tmpl.style.display = 'none';
	return rows.join('');
}

function processes(data) {
	var tmpl = document.getElementById('processes_tmpl');
	tmpl.style.display = '';
	var rows = [];
	for (key in data) {
		for (n in {'age': 0, 'database': 1, 'username': 2, 'query': 3})
			if (!(n in data[key]))
				data[key][n] = '';
		apply(data[key], 'processes.');
		rows.push(tmpl.outerHTML);
	}
	tmpl.style.display = 'none';
	return rows.join('');
}

function humanReadableSize(data) {
	var sizes = ['KB', 'MB', 'GB', 'TB'];
	for (a in sizes) {
		if (data / 1024 < 1)
			return data.toFixed(1) + sizes[a];
		data /= 1024;
	}
	return data.toFixed(1) + sizes[sizes.length - 1];
}

function getValue(data, ns) {
	if (ns == 'disk_stats')
		return disk_stats(data);
	else if (ns == 'processes')
		return processes(data);

	if ((ns.indexOf('.io.') > -1 && ns.indexOf('.io.await') == -1)
			|| ns == 'processes.uss')
		data /= 1024;

	if (ns.indexOf('processes.cpu.') === 0 || ns.indexOf('processes.io.') === 0
			|| ns.indexOf('system_stats.cpu.') === 0
			|| ns.indexOf('disk_stats.device.io.') === 0
			|| ns == 'system_stats.iowait'
			|| ns == 'processes.uss')
		return data.toFixed(1)
	else if (ns.indexOf('system_stats.load_average.') === 0)
		return data.toFixed(2)
	else if (ns.indexOf('.memory.') > -1 || ns.indexOf('.space.') > -1
			|| ns == 'disk_stats.directory.size')
		return humanReadableSize(data);
	else
		return data;
}

function apply(data, ns) {
	for (key in data) {
		var ns_key = ns + key;
		var el = document.getElementById(ns_key);
		if (el != null)
			el.innerHTML = getValue(data[key], ns_key);
		else if (typeof(data[key]) == 'object')
			apply(data[key], ns_key + '.');
	}
}

function body_loaded() {
	setInterval(function() {
		loadJSON('/', function(data) {apply(data, '')}, alert);
	}, 1000);
}
</script>
</head>
<body onLoad='body_loaded()'>
<b id='hostname'></b>, up <b id='system_stats.uptime'></b> <b id='cpu_cores'></b> cores, <b id='sysname'></b>, load average: <b id='system_stats.load_average.0'></b> <b id='system_stats.load_average.1'></b> <b id='system_stats.load_average.2'></b><br/>
sys: utime <b id='system_stats.cpu.user'></b> stime <b id='system_stats.cpu.system'></b> idle <b id='system_stats.cpu.idle'></b> iowait <b id='system_stats.iowait'></b> ctxt <b id='system_stats.ctxt'></b> run <b id='system_stats.processes.running'></b> block <b id='system_stats.processes.blocked'></b><br/>
mem: total <b id='system_stats.memory.total'></b> free <b id='sysname.memory.free'></b> buffers <b id='system_stats.memory.buffers'></b> cached <b id='system_stats.memory.cached'></b> dirty <b id='system_stats.memory.dirty'></b> limit <b id='system_stats.memory.commit_limit'></b> as <b id='system_stats.memory.committed_as'></b><br/>
<b id='postgresql.data_directory'></b> <b id='postgresql.version'></b> <b id='postgresql.role'></b> connections: <b id='postgresql.connections.total'></b> of <b id='postgresql.connections.max'></b> allocated, <b id='postgresql.connections.active'></b> active<br/>
<table border='1'>
<tr><th colspan='4'>Device</th><th colspan='3'>IO</th><th colspan='2'>Location</th></tr>
<tr><th>type</th><th>dev</th><th>size</th><th>Avail</th><th title='Read'>r</th><th title='Write'>w</th><th title='Await'>a</th><th>Size</th><th>Path</th></tr>
<tr id='disk_stats_tmpl'><td id='disk_stats.device.type'></td><td id='disk_stats.device.name'></td><td id='disk_stats.device.space.total'></td><td id='disk_stats.device.space.left'></td><td id='disk_stats.device.io.read'></td><td id='disk_stats.device.io.write'></td><td id='disk_stats.device.io.await'></td><td id='disk_stats.directory.size'></td><td id='disk_stats.directory.name'></td></tr>
<tbody id='disk_stats'></tbody>
</table>

<table border='1'>
<tr><th rowspan='2'>pid</th><th rowspan='2'>type</th><th rowspan='2'>s</th><th colspan='3'>CPU</th><th colspan='2'>IO</th><th rowspan='2'>uss</th><th rowspan='2'>age</th><th rowspan='2'>db</th><th rowspan='2'>user</th><th rowspan='2'>query</th></tr>
<tr><th title='User'>u</th><th title='System'>s</th><th title='Guest'>g</th><th title='Read'>r</th><th title='Write'>w</th></tr>
<tr id='processes_tmpl'><td id='processes.pid'></td><td id='processes.type'></td><td id='processes.state'></td><td id='processes.cpu.user'></td><td id='processes.cpu.system'></td><td id='processes.cpu.guest'></td><td id='processes.io.read'></td><td id='processes.io.write'></td><td id='processes.uss'></td><td id='processes.age'></td><td id='processes.database'></td><td id='processes.username'></td><td id='processes.query'></td></tr>
<tbody id='processes'></tbody>
</table>
</body>
</html>
